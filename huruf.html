<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó£Ô∏è AR ALPHA-TALK: BELAJAR MEMBACA</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; background: #dfe6e9; overflow: hidden; font-family: 'Nunito', sans-serif; }
        canvas { position: absolute; width: 100%; height: 100%; }
        video { display: none; }

        /* START SCREEN */
        #start-screen {
            position: fixed; inset: 0; background: #00cec9; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white;
        }
        .btn-play {
            background: #fdcb6e; color: #d63031; border: 4px solid white; 
            padding: 20px 60px; font-size: 2rem; border-radius: 50px; font-family: 'Fredoka One';
            cursor: pointer; margin-top: 30px; transition: 0.2s; box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        }
        .btn-play:active { transform: translateY(5px); box-shadow: none; }

        /* HUD AREA */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 180px;
            background: rgba(255,255,255,0.9); border-bottom: 6px solid #fdcb6e;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 10px; box-sizing: border-box; z-index: 10;
        }

        /* Tampilan Kalimat Utuh (Kecil di atas) */
        #sentence-context {
            font-size: 1.2rem; color: #636e72; letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase;
        }

        /* Tampilan Kata yang Sedang Dimainkan (Besar) */
        #word-target {
            font-family: 'Fredoka One'; font-size: 4rem; color: #2d3436; letter-spacing: 15px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        .correct { color: #00b894; }
        .pending { color: #dfe6e9; -webkit-text-stroke: 3px #b2bec3; }

        /* Timer & Hint */
        #bottom-hud {
            display: flex; gap: 40px; margin-top: 10px; font-size: 1.5rem; font-family: 'Fredoka One';
        }
        .timer-box { color: #d63031; background: #fab1a0; padding: 5px 20px; border-radius: 20px; border: 3px solid white; }
        .hint-box { color: #0984e3; }

        /* TOAST FINISH */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #00cec9; color: white; padding: 40px 80px;
            border-radius: 40px; font-size: 3rem; font-family: 'Fredoka One';
            display: none; z-index: 100; text-align: center; border: 10px solid white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop { 0% {transform: translate(-50%, -50%) scale(0);} 100% {transform: translate(-50%, -50%) scale(1);} }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-family: 'Fredoka One'; font-size: 4rem; margin: 0;">ALPHA TALK üó£Ô∏è</h1>
        <p style="font-size: 1.5rem;">Tangkap Huruf, Baca Kalimat!</p>
        <button class="btn-play" onclick="startGame()">MULAI BELAJAR ‚ñ∂</button>
    </div>

    <div id="hud">
        <div id="sentence-context">KALIMAT: ...</div>
        <div id="word-target"></div>
        <div id="bottom-hud">
            <div class="timer-box">‚è≥ <span id="timer-val">60</span>s</div>
            <div class="hint-box">CARI: <span id="next-char" style="font-size: 2rem;">?</span></div>
        </div>
    </div>

    <div id="toast">HEBAT! üéâ</div>

    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <script>
        // --- DATABASE KALIMAT (Latihan Membaca) ---
        // Tiap level adalah satu kalimat utuh yang dipecah jadi kata-kata.
        const SENTENCES = [
            ["SAYA", "SUKA", "BACA"],
            ["IBU", "MASAK", "NASI"],
            ["AYAH", "MINUM", "KOPI"],
            ["BUDI", "MAIN", "BOLA"],
            ["SITI", "BELI", "BUKU"]
        ];

        // --- WARNA-WARNI PASTEL ---
        const COLORS = ["#ff7675", "#74b9ff", "#55efc4", "#ffeaa7", "#a29bfe", "#fdcb6e"];

        let state = {
            sentenceIdx: 0, // Kalimat keberapa
            wordIdx: 0,     // Kata keberapa dalam kalimat
            currentWord: "",
            caughtIdx: 0,   // Huruf keberapa dalam kata
            letters: [],    // Huruf terbang
            
            handX: 0, handY: 0, isPinching: false,
            timer: 60, isPlaying: false,
            gameLoopId: null, timerId: null
        };

        // --- AUDIO ENGINE (TTS & SFX) ---
        const actx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(type) {
            if (actx.state === 'suspended') actx.resume();
            const osc = actx.createOscillator(); const gain = actx.createGain();
            osc.connect(gain); gain.connect(actx.destination);
            const now = actx.currentTime;

            if (type === 'pop') { 
                osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.1, now); 
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now); 
                osc.frequency.linearRampToValueAtTime(1046, now + 0.3);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 1);
            }
            osc.start(now); osc.stop(now + 1);
        }

        function speak(text) {
            // Cek browser support
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop suara sebelumnya
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'id-ID'; // Bahasa Indonesia
                msg.rate = 0.9;     // Sedikit lambat biar jelas buat anak
                msg.pitch = 1.2;    // Sedikit tinggi biar ceria
                window.speechSynthesis.speak(msg);
            }
        }

        // --- GAME SYSTEM ---
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            camera.start();
            state.isPlaying = true;
            loadSentence();
        }

        function loadSentence() {
            state.wordIdx = 0;
            updateSentenceContext();
            loadWord();
        }

        function loadWord() {
            const sentence = SENTENCES[state.sentenceIdx % SENTENCES.length];
            state.currentWord = sentence[state.wordIdx];
            state.caughtIdx = 0;
            state.letters = [];
            state.timer = 60; // Reset timer per kata

            // Spawn Huruf (TARGET + PENGECOH)
            const chars = state.currentWord.split('');
            // Tambah 3 huruf pengecoh acak
            for(let i=0; i<3; i++) chars.push(String.fromCharCode(65 + Math.floor(Math.random()*26)));
            
            chars.forEach(c => {
                state.letters.push({
                    char: c,
                    x: Math.random() * (window.innerWidth - 150) + 75,
                    y: Math.random() * (window.innerHeight - 250) + 100,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    color: COLORS[Math.floor(Math.random() * COLORS.length)], // Warna Warni
                    scale: 1
                });
            });

            updateHUD();
            startTimer();
            speak("Cari kata... " + state.currentWord);
        }

        function startTimer() {
            clearInterval(state.timerId);
            state.timerId = setInterval(() => {
                if(!state.isPlaying) return;
                state.timer--;
                document.getElementById('timer-val').innerText = state.timer;
                if(state.timer <= 0) {
                    speak("Waktu habis! Coba lagi.");
                    loadWord(); // Restart kata
                }
            }, 1000);
        }

        function updateSentenceContext() {
            const sentence = SENTENCES[state.sentenceIdx % SENTENCES.length];
            // Highlight kata yg sedang dimainkan
            let html = sentence.map((w, i) => 
                i === state.wordIdx ? `<u style="color:#0984e3">${w}</u>` : w
            ).join(" ");
            document.getElementById('sentence-context').innerHTML = "KALIMAT: " + html;
        }

        function updateHUD() {
            const container = document.getElementById('word-target');
            container.innerHTML = "";
            const word = state.currentWord;
            
            for(let i=0; i<word.length; i++) {
                const span = document.createElement('span');
                span.innerText = word[i];
                if (i < state.caughtIdx) span.className = 'correct';
                else span.className = 'pending';
                container.appendChild(span);
            }
            
            if (state.caughtIdx < word.length) {
                document.getElementById('next-char').innerText = word[state.caughtIdx];
            } else {
                document.getElementById('next-char').innerText = "‚úÖ";
            }
        }

        function checkCatch() {
            if (!state.isPinching) return;

            // Cari huruf terdekat
            let closest = null; let minD = 80; // Radius nangkep lebih gede biar gampang
            state.letters.forEach((l, idx) => {
                const d = Math.hypot(state.handX - l.x, state.handY - l.y);
                if (d < minD) { minD = d; closest = {data: l, idx: idx}; }
            });

            if (closest) {
                const targetChar = state.currentWord[state.caughtIdx];
                
                if (closest.data.char === targetChar) {
                    // BENAR
                    playTone('pop');
                    speak(targetChar); // EJA HURUF (misal: "A")
                    
                    state.letters.splice(closest.idx, 1);
                    state.caughtIdx++;
                    updateHUD();

                    // Cek Selesai Kata
                    if (state.caughtIdx >= state.currentWord.length) {
                        wordComplete();
                    }
                } else {
                    // SALAH (Mental)
                    closest.data.vx = (closest.data.x - state.handX) * 0.3;
                    closest.data.vy = (closest.data.y - state.handY) * 0.3;
                }
            }
        }

        function wordComplete() {
            clearInterval(state.timerId);
            const sentence = SENTENCES[state.sentenceIdx % SENTENCES.length];
            
            // BACA KATA (misal: "BUKU")
            speak(state.currentWord); 

            state.wordIdx++;
            
            if (state.wordIdx >= sentence.length) {
                // KALIMAT SELESAI
                setTimeout(() => {
                    const fullSentence = sentence.join(" ");
                    speak("Hebat! " + fullSentence); // BACA KALIMAT FULL
                    
                    const t = document.getElementById('toast');
                    t.innerText = fullSentence + " ‚úÖ";
                    t.style.display = 'block';
                    playTone('win');

                    setTimeout(() => {
                        t.style.display = 'none';
                        state.sentenceIdx++;
                        loadSentence();
                    }, 4000);
                }, 1000);
            } else {
                // LANJUT KATA BERIKUTNYA
                setTimeout(loadWord, 1500);
            }
        }

        // --- DRAWING LOOP ---
        function onResults(results) {
            const canvas = document.getElementById('output_canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const W = canvas.width; const H = canvas.height;

            // 1. Video Background
            ctx.save(); ctx.translate(W, 0); ctx.scale(-1, 1); 
            ctx.drawImage(results.image, 0, 0, W, H); ctx.restore();
            ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.fillRect(0,0,W,H);

            if (state.isPlaying) {
                // 2. Gambar Huruf (WARNA WARNI & BESAR)
                ctx.font = "bold 90px 'Fredoka One'"; // FONT LEBIH BESAR
                ctx.textAlign = "center"; ctx.textBaseline = "middle";

                state.letters.forEach(l => {
                    // Move
                    l.x += l.vx; l.y += l.vy;
                    if (l.x < 50 || l.x > W-50) l.vx *= -1;
                    if (l.y < 50 || l.y > H-50) l.vy *= -1;

                    ctx.save(); ctx.translate(l.x, l.y);
                    
                    // Bubble Background (Warna Warni)
                    ctx.beginPath(); ctx.arc(0, 0, 55, 0, Math.PI*2);
                    ctx.fillStyle = l.color; ctx.fill();
                    ctx.strokeStyle = "white"; ctx.lineWidth = 5; ctx.stroke();
                    // Shadow
                    ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 10; ctx.shadowOffsetY = 5;

                    // Text Huruf
                    ctx.fillStyle = "white"; 
                    ctx.fillText(l.char, 0, 5);
                    ctx.restore();
                });

                // 3. Hand Skeleton
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    const ix = W - (lm[8].x * W); const iy = lm[8].y * H;
                    const tx = W - (lm[4].x * W); const ty = lm[4].y * H;
                    
                    state.handX += (ix - state.handX) * 0.5; 
                    state.handY += (iy - state.handY) * 0.5;
                    state.isPinching = Math.hypot(ix - tx, iy - ty) < 60;

                    drawSkeleton(ctx, lm, W, H);
                    checkCatch();
                }
            }
        }

        function drawSkeleton(ctx, lm, W, H) {
            ctx.save(); ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineWidth=8;
            ctx.strokeStyle = "#00cec9"; // CYAN Skeleton (Anti-Bug style)
            
            const bones = [[0,1],[1,2],[2,3],[3,4], [0,5],[5,6],[6,7],[7,8], [5,9],[9,10],[10,11],[11,12], [9,13],[13,14],[14,15],[15,16], [13,17],[17,18],[18,19],[19,20], [0,17]];
            ctx.beginPath();
            bones.forEach(b => {
                const p1 = lm[b[0]]; const p2 = lm[b[1]];
                ctx.moveTo(W - p1.x * W, p1.y * H); ctx.lineTo(W - p2.x * W, p2.y * H);
            });
            ctx.stroke();

            // Joints
            for(let p of lm) {
                ctx.beginPath(); ctx.arc(W - p.x * W, p.y * H, 6, 0, Math.PI*2);
                ctx.fillStyle = "white"; ctx.fill();
            }

            // Cursor
            ctx.beginPath(); ctx.arc(state.handX, state.handY, 35, 0, Math.PI*2);
            ctx.fillStyle = state.isPinching ? "#fdcb6e" : "rgba(255,255,255,0.4)";
            ctx.fill(); ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();
            ctx.restore();
        }

        // --- INIT ---
        const video = document.getElementById('input_video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 1280, height: 720
        });
    </script>
</body>
</html>