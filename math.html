<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ AR MATEMATIKA: TK EDITION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; background: #55efc4; overflow: hidden; font-family: 'Fredoka One', cursive; }
        canvas { position: absolute; width: 100%; height: 100%; }
        video { display: none; }

        /* START SCREEN */
        #start-screen {
            position: fixed; inset: 0; background: #ffeaa7; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #d63031;
        }
        .mode-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 30px; }
        .btn-mode {
            background: #00cec9; color: white; border: 4px solid white; 
            padding: 15px 30px; font-size: 1.5rem; border-radius: 30px; font-family: 'Fredoka One';
            cursor: pointer; box-shadow: 0 8px 0 #00b894; transition: 0.1s; width: 200px;
        }
        .btn-mode:active { transform: translateY(5px); box-shadow: 0 4px 0 #00b894; }
        
        /* HUD SKOR & NYAWA */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 120px;
            display: none; justify-content: space-between; align-items: center;
            padding: 0 30px; box-sizing: border-box; z-index: 10;
        }
        .hud-left { display: flex; gap: 15px; align-items: center; }
        .hud-box {
            background: white; padding: 10px 20px; border-radius: 20px;
            font-size: 1.5rem; border: 4px solid #fdcb6e; color: #fdcb6e;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;
        }
        .btn-back {
            background: #ff7675; color: white; border: 3px solid white;
            padding: 10px 20px; border-radius: 20px; font-family: 'Fredoka One';
            cursor: pointer; font-size: 1.2rem; box-shadow: 0 5px 0 #d63031;
        }
        .btn-back:active { transform: translateY(3px); box-shadow: 0 2px 0 #d63031; }

        /* TOAST */
        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: #00b894; color: white; padding: 20px 60px;
            border-radius: 50px; font-size: 3rem; display: none; z-index: 100;
            border: 8px solid white; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        /* GAME OVER OVERLAY */
        #game-over {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; gap: 20px;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 3.5rem; margin-bottom: 10px;">üßÆ MATEMATIKA SERU</h1>
        <p style="font-size: 1.2rem;">Pilih Mode Permainan:</p>
        
        <div class="mode-container">
            <button class="btn-mode" onclick="startGame('add')" style="background:#ff7675;">TAMBAH (+)</button>
            <button class="btn-mode" onclick="startGame('sub')" style="background:#0984e3;">KURANG (-)</button>
            <button class="btn-mode" onclick="startGame('mul')" style="background:#fdcb6e;">KALI (√ó)</button>
            <button class="btn-mode" onclick="startGame('div')" style="background:#6c5ce7;">BAGI (√∑)</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="font-size: 4rem; color: #ff7675; margin: 0;">GAME OVER</h1>
        <p style="font-size: 2rem;">Skor Kamu: <span id="final-score">0</span></p>
        <div style="display: flex; gap: 20px;">
            <button class="btn-mode" onclick="backToMenu()" style="background:#636e72; width: auto;">üè† MENU</button>
            <button class="btn-mode" onclick="startGame(state.mode)" style="width: auto;">MAIN LAGI ‚Ü∫</button>
        </div>
    </div>

    <div id="hud">
        <div class="hud-left">
            <button class="btn-back" onclick="backToMenu()">üè† KEMBALI</button>
            <div class="hud-box">‚≠ê <span id="score-txt">0</span></div>
        </div>
        <div class="hud-box">‚ù§Ô∏è <span id="lives-txt">3</span></div>
    </div>

    <div id="toast">BENAR! üéâ</div>

    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <script>
        // --- CONFIG & STATE ---
        const COLORS = ["#ff7675", "#74b9ff", "#a29bfe", "#fdcb6e", "#55efc4"];
        
        let state = {
            mode: 'add', score: 0, lives: 3, items: [], heldItem: null,
            handX: 0, handY: 0, isPinching: false, isPlaying: false,
            currentQ: { n1: 0, n2: 0, res: 0, opSym: '+', missingIdx: 2, ans: 0 },
            dropZone: {x:0, y:0, w:0, h:0}
        };

        const actx = new (window.AudioContext || window.webkitAudioContext)();

        // --- AUDIO & TTS ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'id-ID'; msg.rate = 0.9; 
                window.speechSynthesis.speak(msg);
            }
        }

        function playSFX(type) {
            if (actx.state === 'suspended') actx.resume();
            const osc = actx.createOscillator(); const gain = actx.createGain();
            osc.connect(gain); gain.connect(actx.destination);
            const now = actx.currentTime;

            if (type === 'pop') { 
                osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.1, now); 
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle'; 
                osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.2);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.5);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; 
                osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            }
            osc.start(now); osc.stop(now + 0.5);
        }

        // --- NAVIGATION ---
        function backToMenu() {
            state.isPlaying = false;
            state.items = []; 
            document.getElementById('hud').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }

        // --- MATH GENERATOR ---
        function generateQuestion() {
            let n1, n2, res, opSym, missingIdx, ans;
            
            if (state.mode === 'add') {
                n1 = Math.floor(Math.random() * 9) + 1; n2 = Math.floor(Math.random() * 9) + 1; 
                res = n1 + n2; opSym = "+";
            } else if (state.mode === 'sub') {
                n2 = Math.floor(Math.random() * 9) + 1; res = Math.floor(Math.random() * 9) + 1; 
                n1 = n2 + res; opSym = "-";
            } else if (state.mode === 'mul') {
                n1 = Math.floor(Math.random() * 5) + 1; n2 = Math.floor(Math.random() * 5) + 1;
                res = n1 * n2; opSym = "√ó";
            } else if (state.mode === 'div') {
                n2 = Math.floor(Math.random() * 3) + 2; res = Math.floor(Math.random() * 4) + 1;
                n1 = n2 * res; opSym = ":";
            }

            missingIdx = Math.floor(Math.random() * 3);
            if (missingIdx === 0) ans = n1;
            else if (missingIdx === 1) ans = n2;
            else ans = res;

            state.currentQ = { n1, n2, res, opSym, missingIdx, ans };
            
            const missingTxt = "titik titik";
            let opSpeak = opSym === ':' ? 'bagi' : opSym === '√ó' ? 'kali' : opSym === '-' ? 'kurang' : 'tambah';
            let qText = "";
            if (missingIdx === 0) qText = `${missingTxt} ${opSpeak} ${n2} sama dengan ${res}`;
            else if (missingIdx === 1) qText = `${n1} ${opSpeak} ${missingTxt} sama dengan ${res}`;
            else qText = `${n1} ${opSpeak} ${n2} sama dengan berapa?`;
            
            speak(qText);
        }

        // --- GAME SYSTEM ---
        function startGame(mode) {
            state.mode = mode; state.score = 0; state.lives = 3; state.items = [];
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('score-txt').innerText = 0;
            document.getElementById('lives-txt').innerText = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
            
            camera.start();
            state.isPlaying = true;
            generateQuestion();
            loop();
        }

        function spawnItem() {
            const isCorrect = Math.random() > 0.4; 
            let val;
            
            if (isCorrect) {
                val = state.currentQ.ans.toString();
            } else {
                let wrongVal;
                do { wrongVal = Math.max(0, state.currentQ.ans + Math.floor(Math.random() * 5) - 2); } 
                while (wrongVal === state.currentQ.ans);
                val = wrongVal.toString();
            }

            const tkSpeed = 0.8 + (state.score * 0.005); 
            state.items.push({
                val: val, isCorrect: parseInt(val) === state.currentQ.ans,
                x: Math.random() * (window.innerWidth - 100) + 50,
                y: -100, speed: tkSpeed, 
                color: COLORS[Math.floor(Math.random() * COLORS.length)]
            });
        }

        function loop() {
            if(!state.isPlaying) return;
            if (Math.random() < 0.015 && state.items.length < 4) spawnItem();

            const H = window.innerHeight;
            for (let i = state.items.length - 1; i >= 0; i--) {
                let item = state.items[i];
                if (item === state.heldItem) { item.x = state.handX; item.y = state.handY; } 
                else { item.y += item.speed; }
                if (item.y > H + 100) state.items.splice(i, 1);
            }

            if (state.isPinching && !state.heldItem) {
                let closest = null; let minD = 80;
                state.items.forEach(item => {
                    const d = Math.hypot(state.handX - item.x, state.handY - item.y);
                    if (d < minD) { minD = d; closest = item; }
                });
                if (closest) {
                    state.heldItem = closest; playSFX('pop'); speak(closest.val); 
                }
            }
            if (!state.isPinching && state.heldItem) {
                checkAnswer(state.heldItem); state.heldItem = null;
            }
            requestAnimationFrame(loop);
        }

        function isInZone(item) {
            const dz = state.dropZone;
            return (item.x > dz.x && item.x < dz.x + dz.w && item.y > dz.y && item.y < dz.y + dz.h);
        }

        function checkAnswer(item) {
            if (isInZone(item)) {
                if (item.isCorrect) {
                    playSFX('win'); showToast("BENAR! üéâ", "#00b894");
                    state.score += 10; document.getElementById('score-txt').innerText = state.score;
                    state.items = []; setTimeout(generateQuestion, 2000); 
                } else {
                    playSFX('wrong'); state.lives--; updateLivesUI();
                    if (state.lives <= 0) doGameOver();
                    else { showToast("SALAH ‚ùå", "#d63031"); item.y = -100; }
                }
            }
        }

        function updateLivesUI() {
            let s = ""; for(let i=0; i<state.lives; i++) s += "‚ù§Ô∏è";
            document.getElementById('lives-txt').innerText = s;
        }
        function doGameOver() {
            state.isPlaying = false;
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('final-score').innerText = state.score;
            speak("Yah, permainan selesai.");
        }
        function showToast(text, color) {
            const t = document.getElementById('toast');
            t.innerText = text; t.style.backgroundColor = color;
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1500);
        }

        // --- RENDER ---
        function onResults(results) {
            const canvas = document.getElementById('output_canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const W = canvas.width; const H = canvas.height;

            ctx.save(); ctx.translate(W, 0); ctx.scale(-1, 1);
            ctx.drawImage(results.image, 0, 0, W, H);
            ctx.restore();

            if(state.isPlaying) { drawBoard(ctx, W, H); drawItems(ctx); }

            // HAND TRACKING & SKELETON
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const ix = (1 - lm[8].x) * W; const iy = lm[8].y * H; 
                const tx = (1 - lm[4].x) * W; const ty = lm[4].y * H; 
                
                state.handX += (ix - state.handX) * 0.5;
                state.handY += (iy - state.handY) * 0.5;
                state.isPinching = Math.hypot(ix - tx, iy - ty) < 60;

                // --- INI SKELETONNYA NABILA! ---
                ctx.save();
                ctx.strokeStyle = "rgba(255, 255, 255, 0.6)"; 
                ctx.lineWidth = 4;
                ctx.lineCap = "round"; ctx.lineJoin = "round";
                const bones = [[0,1],[1,2],[2,3],[3,4], [0,5],[5,6],[6,7],[7,8], [5,9],[9,10],[10,11],[11,12], [9,13],[13,14],[14,15],[15,16], [13,17],[17,18],[18,19],[19,20], [0,17]];
                ctx.beginPath();
                bones.forEach(b => {
                    const p1 = lm[b[0]]; const p2 = lm[b[1]];
                    ctx.moveTo((1 - p1.x) * W, p1.y * H);
                    ctx.lineTo((1 - p2.x) * W, p2.y * H);
                });
                ctx.stroke();
                ctx.restore();
                // -----------------------------

                // Cursor Circle
                ctx.beginPath(); ctx.arc(state.handX, state.handY, 20, 0, Math.PI*2);
                ctx.fillStyle = state.isPinching ? "#fdcb6e" : "rgba(255,255,255,0.5)";
                ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle="white"; ctx.stroke();
            }
        }

        function drawBoard(ctx, W, H) {
            const q = state.currentQ;
            const bw = 800; const bh = 220; 
            const bx = (W - bw) / 2; const by = H - bh - 20;
            
            ctx.fillStyle = "#2d3436";
            ctx.beginPath(); ctx.roundRect(bx, by, bw, bh, 20); ctx.fill();
            ctx.strokeStyle = "#b2bec3"; ctx.lineWidth = 10; ctx.stroke();
            ctx.fillStyle = "#d63031"; ctx.beginPath(); ctx.roundRect(bx+20, by+bh-10, bw-40, 15, 5); ctx.fill();

            const centerY = by + bh/2; const startX = bx + 100; const gap = 150;
            ctx.font = "bold 80px 'Fredoka One'"; ctx.textBaseline = "middle"; ctx.textAlign = "center";
            
            function drawSlot(index, val, xPos) {
                if (q.missingIdx === index) {
                    const zw = 130; const zh = 130;
                    state.dropZone = {x: xPos - zw/2, y: centerY - zh/2, w: zw, h: zh};
                    
                    let isHover = state.heldItem && isInZone(state.heldItem);
                    ctx.fillStyle = isHover ? "rgba(0, 184, 148, 0.5)" : "rgba(255,255,255,0.1)";
                    ctx.strokeStyle = isHover ? "#00b894" : "#ffeaa7";
                    ctx.setLineDash([10, 10]); ctx.lineWidth = 5;
                    ctx.beginPath(); ctx.roundRect(xPos - zw/2, centerY - zh/2, zw, zh, 15);
                    ctx.fill(); ctx.stroke(); ctx.setLineDash([]);
                    
                    if (!isHover) { ctx.fillStyle = "#ffeaa7"; ctx.fillText("?", xPos, centerY + 5); }
                } else { ctx.fillStyle = "white"; ctx.fillText(val, xPos, centerY); }
            }

            drawSlot(0, q.n1, startX);
            ctx.fillStyle = "#fab1a0"; ctx.fillText(q.opSym, startX + gap, centerY);
            drawSlot(1, q.n2, startX + gap*2);
            ctx.fillStyle = "#fab1a0"; ctx.fillText("=", startX + gap*3, centerY);
            drawSlot(2, q.res, startX + gap*4);
        }

        function drawItems(ctx) {
            ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.font = "bold 70px 'Fredoka One'";
            state.items.forEach(item => {
                ctx.save(); ctx.translate(item.x, item.y);
                ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.arc(5, 5, 45, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = item.color;
                if(item === state.heldItem) { ctx.scale(1.2, 1.2); }
                ctx.beginPath(); ctx.arc(0, 0, 45, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 5; ctx.stroke();
                ctx.fillStyle = "white"; ctx.fillText(item.val, 0, 5);
                ctx.restore();
            });
        }

        const video = document.getElementById('input_video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });
    </script>
</body>
</html>